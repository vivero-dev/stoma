---
/**
 * OAuth callback receiver for the Stoma editor.
 *
 * This page captures URL parameters from OAuth provider redirects and
 * sends them back to the editor tab via postMessage. It is a static page
 * with no server-side processing — parameters are read client-side only.
 */
---

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Stoma Editor — OAuth Callback</title>
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png" />
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png" />
    <style>
      *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
      html, body {
        height: 100%;
        background: #1e1e1e;
        color: #d4d4d4;
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      }
      .cb-root {
        max-width: 36rem;
        margin: 0 auto;
        padding: 3rem 1.5rem;
      }
      .cb-logo {
        font-weight: 700;
        font-size: 0.875rem;
        color: #4ec9b0;
        text-decoration: none;
      }
      .cb-title {
        font-size: 1.25rem;
        font-weight: 600;
        margin: 1.5rem 0 0.5rem;
      }
      .cb-notice {
        font-size: 0.8125rem;
        color: #969696;
        margin-bottom: 1.5rem;
        line-height: 1.5;
      }
      .cb-notice strong {
        color: #4ec9b0;
      }
      .cb-status {
        font-size: 0.8125rem;
        color: #4ec9b0;
        margin-bottom: 1rem;
      }
      .cb-status--error {
        color: #f48771;
      }
      .cb-params {
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
        margin-bottom: 1.5rem;
      }
      .cb-param {
        display: flex;
        align-items: flex-start;
        gap: 0.5rem;
        padding: 0.5rem 0.75rem;
        background: #252526;
        border: 1px solid #3c3c3c;
        border-radius: 0.375rem;
      }
      .cb-param-key {
        font-family: "Cascadia Code", "Fira Code", monospace;
        font-size: 0.75rem;
        color: #569cd6;
        white-space: nowrap;
        min-width: 5rem;
        padding-top: 0.0625rem;
      }
      .cb-param-value {
        font-family: "Cascadia Code", "Fira Code", monospace;
        font-size: 0.75rem;
        color: #d4d4d4;
        word-break: break-all;
        flex: 1;
      }
      .cb-copy-btn {
        all: unset;
        display: inline-flex;
        align-items: center;
        height: 1.5rem;
        padding: 0 0.5rem;
        border-radius: 0.25rem;
        border: 1px solid #555;
        color: #d4d4d4;
        font-size: 0.6875rem;
        font-weight: 600;
        cursor: pointer;
        transition: border-color 0.15s, color 0.15s;
        user-select: none;
        white-space: nowrap;
        flex-shrink: 0;
      }
      .cb-copy-btn:hover {
        border-color: #0e639c;
        color: #fff;
      }
      .cb-empty {
        color: #555;
        font-size: 0.8125rem;
        font-style: italic;
      }
      .cb-close {
        all: unset;
        display: inline-flex;
        align-items: center;
        height: 1.75rem;
        padding: 0 0.75rem;
        border-radius: 0.25rem;
        background: #0e639c;
        color: #fff;
        font-size: 0.75rem;
        font-weight: 600;
        cursor: pointer;
        transition: background 0.15s;
        user-select: none;
      }
      .cb-close:hover { background: #1177bb; }
    </style>
  </head>
  <body>
    <div class="cb-root">
      <a href="/" class="cb-logo">Stoma</a>
      <h1 class="cb-title">OAuth Callback Received</h1>
      <p class="cb-notice">
        <strong>No data is logged or transmitted.</strong>
        This page runs entirely in your browser. The parameters below were received
        from the OAuth provider's redirect and are only shown to you. If the editor
        is open, they have been sent back automatically.
      </p>
      <div id="status" class="cb-status"></div>
      <div id="params" class="cb-params"></div>
      <button id="close-btn" class="cb-close" style="display:none">Close Window</button>
    </div>

    <script is:inline>
      (function() {
        const params = new URLSearchParams(window.location.search);
        const paramsContainer = document.getElementById("params");
        const statusEl = document.getElementById("status");
        const closeBtn = document.getElementById("close-btn");

        // Collect all params into an object
        const data = {};
        for (const [key, value] of params.entries()) {
          data[key] = value;
        }

        // Display params
        const keys = Object.keys(data);
        if (keys.length === 0) {
          paramsContainer.innerHTML = '<div class="cb-empty">No parameters received.</div>';
        } else {
          for (const key of keys) {
            const row = document.createElement("div");
            row.className = "cb-param";

            const keyEl = document.createElement("span");
            keyEl.className = "cb-param-key";
            keyEl.textContent = key;

            const valEl = document.createElement("span");
            valEl.className = "cb-param-value";
            valEl.textContent = data[key];

            const copyBtn = document.createElement("button");
            copyBtn.className = "cb-copy-btn";
            copyBtn.textContent = "Copy";
            copyBtn.addEventListener("click", function() {
              navigator.clipboard.writeText(data[key]).then(function() {
                copyBtn.textContent = "Copied!";
                setTimeout(function() { copyBtn.textContent = "Copy"; }, 1500);
              });
            });

            row.appendChild(keyEl);
            row.appendChild(valEl);
            row.appendChild(copyBtn);
            paramsContainer.appendChild(row);
          }
        }

        // Notify opener via postMessage
        var sent = false;
        if (window.opener && !window.opener.closed) {
          try {
            window.opener.postMessage(
              { type: "stoma-oauth-callback", params: data },
              window.location.origin
            );
            sent = true;
            statusEl.textContent = "Parameters sent to editor.";
            closeBtn.style.display = "inline-flex";
            closeBtn.addEventListener("click", function() { window.close(); });
          } catch (e) {
            // Cross-origin or opener closed
          }
        }

        if (!sent && keys.length > 0) {
          statusEl.textContent = "Copy the parameters above and use them in the editor request builder.";
        }

        if (data.error) {
          statusEl.textContent = "The OAuth provider returned an error: " + data.error;
          statusEl.className = "cb-status cb-status--error";
        }
      })();
    </script>
  </body>
</html>
